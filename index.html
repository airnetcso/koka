<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TEST KOSA KATA</title>
  <style>
    /* CSS kamu yang lama, atau minimal biar tampil bagus. Aku skip detail CSS biar fokus ke JS fix */
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f0f4f8; }
    .container { max-width: 600px; margin: auto; }
    .question { margin: 20px 0; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    button { padding: 12px 24px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #45a049; }
    #result { margin-top: 30px; padding: 20px; background: #e8f5e9; border-radius: 8px; }
  </style>
</head>
<body>

<div class="container">
  <h1>TEST KOSA KATA</h1>
  <!-- Login section (contoh sederhana, sesuaikan dengan app kamu) -->
  <div id="login">
    <input id="username" placeholder="Username" />
    <button onclick="login()">LOGIN</button>
  </div>

  <div id="quiz" style="display:none;">
    <div id="timer">Waktu: --:--</div>
    <div id="questions"></div>
    <button id="submitBtn" onclick="submitQuiz()">SUBMIT</button>
  </div>

  <div id="result" style="display:none;"></div>
</div>

<script>
const SPREADSHEET_URL = "https://script.google.com/macros/s/AKfycbzwdfNflhqIyVWo8knAyB2nWtzlkbPiRHfMCJV_O_mxkZravDprrAhMNV3Qu75WFYgk0g/exec"; // GANTI KALAU DEPLOY BARU

let currentUser = "";
let questions = []; // Isi dari JSON soal
let answers = [];
let timeLeft = 3000; // 50 menit dalam detik, sesuaikan
let timerInterval;

// Contoh login sederhana (sesuaikan dengan validCredentials & kodeMapping kamu)
function login() {
  const u = document.getElementById("username").value.trim();
  if (u) {
    currentUser = u;
    document.getElementById("login").style.display = "none";
    document.getElementById("quiz").style.display = "block";
    loadQuestions(); // Fungsi load soal dari JSON
    startTimer();
  } else {
    alert("Masukkan username dulu!");
  }
}

// Load soal (contoh, ganti dengan fetch JSON seperti sebelumnya)
async function loadQuestions() {
  // Misal fetch dari repo kamu
  const res = await fetch("https://raw.githubusercontent.com/airnetcso/latbakor/main/soal/kosa_kata.json"); // GANTI URL JSON SOAL
  questions = await res.json();
  answers = new Array(questions.length).fill(null);

  const qContainer = document.getElementById("questions");
  qContainer.innerHTML = "";
  questions.forEach((q, i) => {
    let html = `<div class="question">
      <p><strong>Soal ${i+1}:</strong> ${q.question}</p>`;
    Object.entries(q.options || {}).forEach(([key, val]) => {
      html += `<label>
        <input type="radio" name="q${i}" value="${key}" onchange="answers[${i}] = '${key}'">
        ${val}
      </label><br>`;
    });
    html += `</div>`;
    qContainer.innerHTML += html;
  });
}

function startTimer() {
  timerInterval = setInterval(() => {
    const min = Math.floor(timeLeft / 60);
    const sec = timeLeft % 60;
    document.getElementById("timer").textContent = `Waktu: ${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
    if (--timeLeft < 0) {
      clearInterval(timerInterval);
      submitQuiz(true); // auto submit kalau habis waktu
    }
  }, 1000);
}

async function submitQuiz(auto = false) {
  clearInterval(timerInterval);
  if (auto) alert("Waktu habis! Submit otomatis.");

  const unanswered = answers.findIndex(a => a === null);
  if (unanswered !== -1 && !confirm("Ada soal belum dijawab. Tetap submit?")) return;

  let score = 0;
  let wrongDetails = [];
  questions.forEach((q, i) => {
    if (answers[i] === q.answer) score++;
    else if (answers[i] !== null) {
      wrongDetails.push(`Soal ${i+1}: Jawaban benar ${q.answer}`);
    }
  });

  const total = questions.length;
  const percent = Math.round((score / total) * 100);
  const keterangan = wrongDetails.length ? wrongDetails.join("; ") : "Semua benar! Perfect!";

  const dataToSend = {
    namaSiswa: currentUser || "Anonymous",
    code: "koka", // atau kode soal
    kosaKata: `${score}/${total} (${percent}%)`,
    ubt: "-",
    latihanSoal: "-",
    keterangan: keterangan,
    waktu: new Date().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' })
  };

  const formData = new URLSearchParams(dataToSend);

  try {
    const res = await fetch(SPREADSHEET_URL, {
      method: "POST",
      body: formData,
      redirect: "follow"
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const result = await res.json();
    console.log("Sukses:", result);

    document.getElementById("quiz").style.display = "none";
    document.getElementById("result").innerHTML = `
      <h2>Nilai: ${score} / ${total} (${percent}%)</h2>
      <p>${keterangan}</p>
      <button onclick="location.reload()">Ulangi</button>
    `;
    document.getElementById("result").style.display = "block";
    alert("Nilai berhasil disimpan ke sheet!");
  } catch (err) {
    console.error("Gagal kirim:", err);
    alert("Gagal kirim ke server. Nilai kamu: " + score + "/" + total + ". Catat manual dulu ya!");
    // Opsional: simpan ke localStorage kalau mau
  }
}
</script>
</body>
</html>
