// === KONFIGURASI ===
const SHEET_NAME = "DATA"; // Nama sheet di Spreadsheet (bisa diganti)

// === DO GET (utama untuk GET query string dari app) ===
function doGet(e) {
  try {
    Logger.log("doGet dipanggil | Parameter lengkap: " + JSON.stringify(e.parameter || {}));

    let data = e.parameter || {};

    if (Object.keys(data).length === 0) {
      Logger.log("WARNING: e.parameter kosong!");
      throw new Error("Tidak ada data parameter yang diterima");
    }

    const sheet = getSheet();

    sheet.appendRow([
      new Date(),                          // A: WAKTU (server timestamp)
      data.n || "Anonymous",               // B: NAMA SISWA
      data.c || "Unknown",                 // C: CODE
      data.k || "-",                       // D: KOSA KATA
      data.u || "-",                       // E: UBT
      data.l || "-",                       // F: LATIHAN SOAL
      data.t || ""                         // G: KETERANGAN
    ]);

    Logger.log("SUKSES APPEND: " + JSON.stringify(data));

    return ContentService.createTextOutput("OK - Data masuk sheet")
      .setMimeType(ContentService.MimeType.TEXT);

  } catch (err) {
    Logger.log("ERROR di doGet: " + err.message + " | Stack: " + err.stack);
    return ContentService.createTextOutput("Error: " + err.message)
      .setMimeType(ContentService.MimeType.TEXT);
  }
}

// === DO POST (fallback kalau ada app yang masih pakai POST) ===
function doPost(e) {
  try {
    Logger.log("doPost dipanggil | Event keys: " + Object.keys(e || {}));

    let data = {};

    // Prioritas 1: form-urlencoded
    if (e.parameter && Object.keys(e.parameter).length > 0) {
      data = e.parameter;
      Logger.log("SUKSES dari e.parameter (form-urlencoded): " + JSON.stringify(data));
    }
    // Prioritas 2: JSON
    else if (e.postData && e.postData.contents) {
      try {
        data = JSON.parse(e.postData.contents);
        Logger.log("SUKSES dari JSON: " + JSON.stringify(data));
      } catch (parseErr) {
        Logger.log("JSON parse gagal: " + parseErr + " | Raw: " + e.postData.contents);
        throw new Error("Invalid JSON");
      }
    } else {
      throw new Error("Tidak ada data valid");
    }

    const sheet = getSheet();
    sheet.appendRow([
      new Date(),
      data.n || data.namaSiswa || "Anonymous",
      data.c || data.code || "Unknown",
      data.k || data.kosaKata || "-",
      data.u || data.ubt || "-",
      data.l || data.latihanSoal || "-",
      data.t || data.keterangan || ""
    ]);

    Logger.log("SUKSES APPEND dari POST: " + JSON.stringify(data));

    return ContentService.createTextOutput("OK - Data masuk sheet")
      .setMimeType(ContentService.MimeType.TEXT);

  } catch (err) {
    Logger.log("ERROR di doPost: " + err.message);
    return ContentService.createTextOutput("Error: " + err.message)
      .setMimeType(ContentService.MimeType.TEXT);
  }
}

// === FUNGSI BANTU SHEET ===
function getSheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName(SHEET_NAME);

  if (!sheet) {
    sheet = ss.insertSheet(SHEET_NAME);
    sheet.appendRow([
      "WAKTU", "NAMA SISWA", "CODE", "KOSA KATA", "UBT", "LATIHAN SOAL", "KETERANGAN"
    ]);

    const header = sheet.getRange("A1:G1");
    header.setFontWeight("bold");
    header.setBackground("#10b981");
    header.setFontColor("white");
    sheet.setFrozenRows(1);
    sheet.autoResizeColumns(1, 7);
  }

  return sheet;
}
